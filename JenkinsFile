pipeline {

  agent any 
    environment {
      IMAGE_NAME = 'localhost:5000/repo'
      IMAGE_TAG = "latest-${env.BUILD_ID}"
     }

    stages {
      stage ('checkout') {
        agent any {lable : 'Buildnode'}
        steps {
          checkout scm
        }
      }   
    } 
   
     stage('Build Docker images') {
        steps {
          sh docker build -t "${IMAGE_NAME}:${IMAGE_TAG}" .
         }
        }  
     stage('push to local registry') {
        steps {
          sh docker push "${IMAGE_NAME}:${IMAGE_TAG}"
            }
        }
     stage('Deploy with docker-compose') {
        environment {
          COMPOSE_FILE = 'docker-compose.yml'
        }
          steps {
            sh docker compose down
            sh 'IMAGE_NAME=${IMAGE_NAME} IMAGE_TAG=${IMAGE_TAG} docker compose up -d '
        }

     post {
        always {
            // Clean up the workspace
            cleanWs()
        }
          
          
}  
  
